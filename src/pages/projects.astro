---
import Layout from "../layouts/Layout.astro";
import projects from "../data/projects.json";

// Sort projects by priority (ascending; missing => low priority)
projects.sort((a, b) => (a.priority ?? 99) - (b.priority ?? 99));

// Collect unique categories (preserve order)
const categories = ["All", ...Array.from(new Set(projects.map((p) => p.category || "Other")))];
---

<Layout title="Projects" description="Things I’ve built, broken, and tinkered with.">
  <section class="py-12 lg:py-20 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Sticky Back to Home -->
    <div class="sticky top-16 z-20 mb-6">
      <a href="/"
         class="inline-flex items-center gap-2 text-sm text-pink-500 hover:underline
                bg-[color:var(--bg)]/60 backdrop-blur-sm px-2 py-1 rounded-md">
        ← Back to Home
      </a>
    </div>

    <!-- Page Title -->
    <h1 class="text-3xl sm:text-4xl font-bold mb-8 text-center lg:text-left">Projects Archive</h1>

    <!-- Category Filter + optional search -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
      <div class="overflow-x-auto py-2 -mx-2 px-2">
        <div class="flex gap-2">
          {categories.map((cat) => (
            <button
              class="proj-filter tag-btn px-3 py-1 rounded-full bg-gray-800 transition text-white text-sm whitespace-nowrap"
              data-cat={cat.toLowerCase()}
              aria-pressed={cat === "All" ? "true" : "false"}
            >
              {cat}
            </button>
          ))}
        </div>
      </div>

      <!-- Optional small search to quickly filter project titles/descriptions -->
      <div class="min-w-0 w-full md:w-64">
        <label for="proj-search" class="sr-only">Search projects</label>
        <input id="proj-search" type="search" placeholder="Search projects..."
               class="w-full px-3 py-2 rounded-md bg-gray-900/50 border border-gray-700 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-pink-500" />
      </div>
    </div>

    <!-- Grid of Projects -->
    <div id="projects-grid" class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
      {projects.map((project) => (
        <article
          class="proj-card p-5 rounded-xl border border-gray-700 bg-gray-900/40 backdrop-blur-sm 
                 shadow-sm hover:shadow-lg hover:border-pink-500 transition flex flex-col"
          data-cat={(project.category || "Other").toLowerCase()}
        >
          <!-- optional thumbnail (add `thumbnail` to your JSON) -->
          {project.thumbnail ? (
            <div class="mb-4 overflow-hidden rounded-md">
              <img src={project.thumbnail} alt={project.title + ' thumbnail'} class="w-full h-40 object-cover block" loading="lazy" />
            </div>
          ) : null}

          <!-- Title -->
          <h3 class="text-lg font-semibold mb-1">{project.title}</h3>

          <!-- Metadata row -->
          <p class="text-xs text-gray-500 mb-3">
            {project.year ?? "—"} · {project.category ?? "Other"} · {project.collab ?? "Solo"}
          </p>

          <!-- Description -->
          <p class="text-gray-300 mb-4 flex-1">{project.description}</p>

          <!-- Tools -->
          {project.tools ? <p class="text-sm text-gray-400 mb-3">Tools: {project.tools}</p> : null}

          <!-- Footer row -->
          <div class="flex items-center justify-between mt-2">
            <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium text-white ${project.statusColor ?? "bg-gray-600"}`}>
              {project.status ?? "Status N/A"}
            </span>

            {project.link ? (
              <a href={project.link} target="_blank" rel="noopener noreferrer"
                 class="text-pink-500 text-sm hover:underline ml-4 whitespace-nowrap">
                View →
              </a>
            ) : (
              <span class="text-xs text-gray-500">No external link</span>
            )}
          </div>
        </article>
      ))}
    </div>
  </section>

  <style>
    html { scroll-behavior: smooth; }

    /* Prevent horizontal overflow on small screens (defensive) */
    @media (max-width: 1024px) {
      html, body { overflow-x: hidden; }
      section { box-sizing: border-box; }
    }

    /* Accessibility & active visual */
    .tag-btn[aria-pressed="true"] {
      background-color: #db2777; /* pink-600 */
      color: #fff;
    }
    .tag-btn:focus { outline: 3px solid rgba(219,39,119,0.18); outline-offset: 3px; }

    /* Card hover */
    .proj-card { transition: transform 120ms ease, box-shadow 120ms ease; }
    .proj-card:hover { transform: translateY(-4px); }

    /* make sure images don't overflow */
    .proj-card img { width: 100%; height: auto; display: block; }

    /* small tweaks for grid on very small devices */
    @media (max-width: 420px) {
      .proj-card { padding: 1rem; }
      .proj-card h3 { font-size: 1.05rem; }
    }
  </style>

  <script is:inline>
    (function () {
      const cards = Array.from(document.querySelectorAll(".proj-card"));
      const buttons = Array.from(document.querySelectorAll(".proj-filter"));
      const search = document.getElementById("proj-search");
      let activeCat = "all";

      function norm(str){ return (str||"").toLowerCase().trim(); }

      function filter() {
        const q = norm(search?.value || "");
        let any = false;
        cards.forEach(c => {
          const cat = norm(c.dataset.cat || "other");
          const title = norm(c.querySelector("h3")?.textContent || "");
          const desc = norm(c.querySelector("p")?.textContent || "");
          const catMatch = activeCat === "all" || cat === activeCat;
          const queryMatch = !q || title.includes(q) || desc.includes(q);
          const show = catMatch && queryMatch;
          c.style.display = show ? "" : "none";
          if (show) any = true;
        });

        // If no matches, show a simple message once
        let no = document.getElementById("no-projects");
        if (!any) {
          if (!no) {
            no = document.createElement("p");
            no.id = "no-projects";
            no.className = "text-gray-400 mt-6 px-2";
            no.textContent = "No projects match that category or search.";
            document.getElementById("projects-grid").after(no);
          }
        } else if (no) {
          no.remove();
        }
      }

      // Simple debounce
      function debounce(fn, wait=180){
        let t;
        return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); };
      }

      const debouncedFilter = debounce(filter, 150);

      // wire buttons (keyboard-friendly)
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          activeCat = (btn.dataset.cat || "all").toLowerCase();
          buttons.forEach(b => {
            const isActive = (b.dataset.cat || "").toLowerCase() === activeCat;
            b.setAttribute("aria-pressed", isActive ? "true" : "false");
            if (isActive) b.classList.add("bg-pink-600");
            else b.classList.remove("bg-pink-600");
          });
          filter();
          btn.focus({preventScroll:true});
        });

        btn.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            btn.click();
          }
        });
      });

      // search
      search?.addEventListener("input", debouncedFilter);

      // initial filter to respect default "All" state
      filter();
    })();
  </script>
</Layout>
